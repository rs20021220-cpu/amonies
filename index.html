<!DOCTYPE html>
<html>
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>アモニ大戦争</title>
<style>
body { margin:0; overflow:hidden; background:black; }
canvas { display:block; margin:0 auto; background:#000; }
</style>
</head>
<body>
<canvas id="game"></canvas>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
canvas.width = 400;
canvas.height = 700;

// ===== 画像 =====
const playerImg = new Image();
playerImg.src = "jikki.jpg";

const enemyImg = new Image();
enemyImg.src = "enemy.jpg";

// ===== 状態 =====
let gameState = "title";
let difficulty = "normal";
let characterType = "red";

// ===== 難易度 =====
const diffSettings = {
  easy: { enemyRate: 60 },
  normal: { enemyRate: 40 },
  hard: { enemyRate: 25 }
};

// ===== 変数 =====
let player, bullets, enemies, enemyBullets;
let score, stage, skill, frame;

// ===== 初期化 =====
function initGame(){
  player = { x:160, y:580, w:70, h:90, life:3, power:1, fireRate:15 };
  bullets = [];
  enemies = [];
  enemyBullets = [];
  score = 0;
  stage = 1;
  skill = 0;
  frame = 0;

  if(characterType==="red") player.power=2;
  if(characterType==="blue") player.fireRate=8;
  if(characterType==="green") player.life=5;
}

// ===== 発射 =====
function shoot(){
  bullets.push({ x:player.x+20, y:player.y, w:6, h:15 });
  bullets.push({ x:player.x+45, y:player.y, w:6, h:15 });
}

// ===== 必殺 =====
function skillAttack(){
  if(skill>=100){
    enemies=[];
    skill=0;
  }
}

// ===== 敵生成 =====
function spawnEnemy(){
  enemies.push({
    x: Math.random()*340,
    y: -50,
    w: 50,
    h: 50,
    hp: 3+stage,
    speed: 2+stage*0.3
  });
}

// ===== 更新 =====
function update(){
  if(gameState!=="play") return;

  frame++;

  if(frame % player.fireRate===0) shoot();
  if(frame % diffSettings[difficulty].enemyRate===0) spawnEnemy();

  bullets.forEach((b,i)=>{
    b.y-=8;
    if(b.y<0) bullets.splice(i,1);
  });

  enemies.forEach((e,ei)=>{
    e.y+=e.speed;

    if(Math.random()<0.01){
      enemyBullets.push({ x:e.x+20, y:e.y+40, w:6, h:15 });
    }

    bullets.forEach((b,bi)=>{
      if(b.x<e.x+e.w && b.x+b.w>e.x &&
         b.y<e.y+e.h && b.y+b.h>e.y){
        e.hp-=player.power;
        bullets.splice(bi,1);
        if(e.hp<=0){
          score+=10;
          skill+=10;
          enemies.splice(ei,1);
        }
      }
    });

    if(e.y>700) enemies.splice(ei,1);
  });

  enemyBullets.forEach((b,bi)=>{
    b.y+=5;
    if(b.x<player.x+player.w && b.x+b.w>player.x &&
       b.y<player.y+player.h && b.y+b.h>player.y){
      player.life--;
      enemyBullets.splice(bi,1);
      if(player.life<=0){
        gameState="gameover";
      }
    }
    if(b.y>700) enemyBullets.splice(bi,1);
  });

  if(score>stage*200) stage++;
}

// ===== 描画 =====
function draw(){
  ctx.clearRect(0,0,400,700);

  if(gameState==="title"){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("アモニ大戦争",40,280);
    ctx.font="20px Arial";
    ctx.fillText("！戦争開始！",120,340);
  }

  else if(gameState==="difficulty"){
    ctx.fillStyle="white";
    ctx.font="30px Arial";
    ctx.fillText("SELECT DIFFICULTY",60,200);
    ctx.fillText("EASY",150,300);
    ctx.fillText("NORMAL",130,350);
    ctx.fillText("HARD",150,400);
  }

  else if(gameState==="character"){
    ctx.fillStyle="white";
    ctx.font="30px Arial";
    ctx.fillText("SELECT CHARACTER",50,200);

    ctx.fillStyle="red";
    ctx.fillRect(60,300,80,80);
    ctx.fillStyle="white";
    ctx.fillText("POWER",60,410);

    ctx.fillStyle="blue";
    ctx.fillRect(160,300,80,80);
    ctx.fillStyle="white";
    ctx.fillText("RAPID",170,410);

    ctx.fillStyle="green";
    ctx.fillRect(260,300,80,80);
    ctx.fillStyle="white";
    ctx.fillText("TANK",270,410);
  }

  else if(gameState==="play"){
    if(playerImg.complete){
      ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);
    } else {
      ctx.fillStyle=characterType;
      ctx.fillRect(player.x,player.y,player.w,player.h);
    }

    ctx.fillStyle="cyan";
    bullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

    enemies.forEach(e=>{
      if(enemyImg.complete){
        ctx.drawImage(enemyImg,e.x,e.y,e.w,e.h);
      } else {
        ctx.fillStyle="red";
        ctx.fillRect(e.x,e.y,e.w,e.h);
      }
    });

    ctx.fillStyle="orange";
    enemyBullets.forEach(b=>ctx.fillRect(b.x,b.y,b.w,b.h));

    ctx.fillStyle="white";
    ctx.fillText("Score:"+score,10,20);
    ctx.fillText("Life:"+player.life,10,40);
    ctx.fillText("Stage:"+stage,10,60);

    ctx.fillStyle="lime";
    ctx.fillRect(10,70,skill*2,8);
    ctx.strokeRect(10,70,200,8);

    // MENUボタン
    ctx.fillStyle="gray";
    ctx.fillRect(300,10,80,30);
    ctx.fillStyle="black";
    ctx.fillText("MENU",315,30);
  }

  else if(gameState==="gameover"){
    ctx.fillStyle="white";
    ctx.font="40px Arial";
    ctx.fillText("GAME OVER",90,300);
    ctx.font="20px Arial";
    ctx.fillText("TAP TO TITLE",110,350);
  }
}

// ===== 操作 =====
canvas.addEventListener("click",e=>{

  if(gameState==="title"){
    gameState="difficulty";
  }

  else if(gameState==="difficulty"){
    if(e.offsetY<320) difficulty="easy";
    else if(e.offsetY<370) difficulty="normal";
    else difficulty="hard";
    gameState="character";
  }

  else if(gameState==="character"){
    if(e.offsetX<140) characterType="red";
    else if(e.offsetX<240) characterType="blue";
    else characterType="green";
    initGame();
    gameState="play";
  }

  else if(gameState==="play"){
    if(e.offsetX>300 && e.offsetY<40){
      gameState="title";
      return;
    }
    skillAttack();
  }

  else if(gameState==="gameover"){
    gameState="title";
  }
});

canvas.addEventListener("mousemove",e=>{
  if(gameState==="play"){
    player.x=e.offsetX-35;
  }
});

canvas.addEventListener("touchmove",e=>{
  if(gameState==="play"){
    player.x=e.touches[0].clientX-35;
  }
});

// ===== ループ =====
function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
}
loop();
</script>
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js");
}
</script>
</body>
</html>
